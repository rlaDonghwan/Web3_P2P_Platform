<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>장바구니</title>
    <link rel="stylesheet" th:href="@{/css/cart_sytle.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<div th:insert="~{nav.html}"></div>

<div th:insert="~{popup.html}"></div>

<script th:src="@{/js/login.js}"></script>

<div class="cart-container">
    <div class="cart-items">
        <h2>장바구니 상품</h2>
        <div th:each="cartItem : ${cartItems}" class="cart-item">
            <input type="checkbox" class="item-checkbox" checked onclick="updateTotal()" th:attr="data-price=${cartItem.price * cartItem.quantity}">
            <img th:src="${cartItem.item.images[0]?.base64Image}" alt="Item Image">
            <div class="cart-item-details">
                <h4 th:text="${cartItem.item.itemName}">상품 이름</h4>
                <p class="cart-item-price" th:text="'₩' + ${cartItem.price}">가격</p>
                <select class="item-quantity" th:attr="data-cart-item-id=${cartItem.id}" onchange="updateQuantity(this)">
                    <option th:each="i : ${#numbers.sequence(1, 10)}" th:value="${i}" th:text="${i}"
                            th:selected="${i == cartItem.quantity}"></option>
                </select>
            </div>
            <button class="remove-btn" th:attr="data-cart-item-id=${cartItem.id}" onclick="removeItem(this)">삭제</button>
        </div>
    </div>

    <div class="cart-summary">
        <h2>주문 요약</h2>
        <p>총 상품 금액: <span id="totalPrice" th:text="'₩' + ${totalPrice}">0원</span></p>
        <p>배송비: <span>무료</span></p>
        <p>총 결제 금액: <span id="finalPrice" th:text="'₩' + ${totalPrice}">0원</span></p>
        <button class="checkout-btn" onclick="checkout()">구매하기</button>
    </div>
</div>

<script>
    // 페이지가 로드될 때 총 금액을 계산
    document.addEventListener("DOMContentLoaded", updateTotal);

    function updateTotal() {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        let totalPrice = 0;

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const pricePerItem = parseInt(checkbox.getAttribute('data-price')) / parseInt(checkbox.parentElement.querySelector('.item-quantity').value);
                const quantity = parseInt(checkbox.parentElement.querySelector('.item-quantity').value);
                const totalItemPrice = pricePerItem * quantity;
                totalPrice += totalItemPrice;
                checkbox.setAttribute('data-price', totalItemPrice);
            }
        });

        document.getElementById("totalPrice").innerText = '₩' + totalPrice.toLocaleString();
        document.getElementById("finalPrice").innerText = '₩' + totalPrice.toLocaleString();
    }

    // 장바구니에서 아이템 수량 변경 시 호출
    function updateQuantity(element) {
        const cartItemId = element.getAttribute("data-cart-item-id");
        const quantity = element.value;

        console.log("cartItemId:", cartItemId); // 올바른 값인지 확인
        console.log("quantity:", quantity);     // 올바른 값인지 확인

        // 유효성 검사
        if (!cartItemId || isNaN(cartItemId) || !quantity || isNaN(quantity) || parseInt(quantity) < 1) {
            alert("유효하지 않은 cartItemId 또는 quantity입니다.");
            return;
        }

        fetch('/cart/updateQuantity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cartItemId: parseInt(cartItemId), quantity: parseInt(quantity) })
        })
            .then(response => {
                if (!response.ok) {
                    console.error(`Server error: ${response.status}`);
                    return response.text().then(text => {
                        alert(`오류가 발생했습니다: ${text}` || "알 수 없는 오류");
                    });
                } else {
                    // 업데이트 후 페이지 새로고침
                    location.reload(); // 페이지 새로 고침
                }
            })
            .catch(error => console.error('Fetch error:', error));
    }

    function removeItem(element) {
        const cartItemId = element.getAttribute("data-cart-item-id");

        if (confirm("정말로 이 상품을 삭제하시겠습니까?")) {
            fetch('/cart/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ cartItemId: cartItemId })
            })
                .then(response => {
                    if (!response.ok) {
                        console.error(`Server error: ${response.status}`);
                        return response.text().then(text => {
                            alert(`오류가 발생했습니다: ${text}` || "알 수 없는 오류");
                        });
                    } else {
                        // 삭제 후 페이지 새로고침
                        location.reload();
                    }
                })
                .catch(error => console.error('Fetch error:', error));
        }
    }
</script>
</body>
</html>