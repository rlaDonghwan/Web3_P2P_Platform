<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장바구니 결제</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/sendEther.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="container mt-5">
    <div id="nav" class="fixed-top"></div>
    <div id="popup"></div>
    <script src="/js/login.js"></script>

    <!-- 데이터 디버깅 -->
    <div>
        <h3>데이터 디버깅</h3>
        <p>Contract Address: <span id="contractAddress">N/A</span></p>
        <p>Total Price: <span id="totalPrice">0</span></p>
        <p>Seller Addresses: <span id="sellerAddresses">[]</span></p>
        <p>Seller Amounts: <span id="sellerAmounts">[]</span></p>
    </div>

    <!-- 판매자별 상품 -->
    <div id="sellerItems" class="mb-3 p-3 border rounded"></div>

    <h3>총 금액: <span id="totalPriceDisplay">0</span> 원</h3>
    <p>이더리움 금액: <span id="ethPrice">계산 중...</span> ETH</p>

    <!-- 결제 정보 입력 -->
    <h4>결제 정보 입력</h4>
    <form id="paymentForm">
        <div class="form-group">
            <label for="buyerName">이름:</label>
            <input type="text" id="buyerName" name="buyerName" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="buyerAddress">주소:</label>
            <input type="text" id="buyerAddress" name="buyerAddress" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="buyerContact">연락처:</label>
            <input type="text" id="buyerContact" name="buyerContact" class="form-control" required>
        </div>

        <!-- 이더리움 금액을 저장할 숨겨진 필드 -->
        <input type="hidden" id="ethAmount" name="ethAmount">

        <button type="button" id="submitPaymentBtn" class="btn btn-primary btn-block">결제하기</button>
    </form>
</div>

<script>
    let contractABI;

    // 장바구니 세부 정보 가져오기 및 렌더링
    async function fetchCartDetails() {
        try {
            console.log("[INFO] Fetching cart details...");
            const cartId = sessionStorage.getItem('cartId'); // 세션에서 Cart ID 가져오기
            if (!cartId) {
                alert("장바구니가 비어 있습니다.");
                window.location.href = '/cart'; // 장바구니 페이지로 리다이렉트
                return;
            }

            const response = await fetch(`/api/cart/details?cartId=${cartId}`);
            if (!response.ok) throw new Error("Failed to fetch cart details");

            const data = await response.json();
            const cartData = data.cartData;

            // Contract Address 및 Total Price 렌더링
            document.getElementById('contractAddress').innerText = cartData.contractAddress || "N/A";
            document.getElementById('totalPrice').innerText = cartData.totalPrice || 0;
            document.getElementById('totalPriceDisplay').innerText = cartData.totalPrice || 0;

            // Seller Addresses 및 Amounts 렌더링
            document.getElementById('sellerAddresses').innerText = cartData.sellerAddresses.join(", ");
            document.getElementById('sellerAmounts').innerText = cartData.sellerAmounts.join(", ");

            // 판매자별 상품 렌더링
            const sellerItemsMap = cartData.sellerItemsMap || {};
            const sellerItemsContainer = document.getElementById('sellerItems');
            sellerItemsContainer.innerHTML = ''; // 기존 내용 초기화

            for (const [seller, items] of Object.entries(sellerItemsMap)) {
                const sellerDiv = document.createElement('div');
                sellerDiv.className = "mb-3 p-3 border rounded";
                sellerDiv.innerHTML = `<h5>판매자: ${seller.substring(0, 10)}</h5>`;

                items.forEach(item => {
                    sellerDiv.innerHTML += `
                        <div>
                            <img src="${item.item.images[0]?.base64Image || '/images/default.jpg'}"
                                 alt="상품 이미지" style="width: 100px; height: 100px; object-fit: cover; margin-right: 10px;">
                            <p>상품명: ${item.item.itemName}</p>
                            <p>수량: ${item.quantity}</p>
                            <p>가격: ₩${item.price * item.quantity}</p>
                        </div>
                    `;
                });

                sellerItemsContainer.appendChild(sellerDiv);
            }

            console.log("[INFO] Cart details fetched and rendered successfully:", cartData);

        } catch (error) {
            console.error("[ERROR] Failed to fetch cart details:", error);
            alert("장바구니 데이터를 가져오는 중 오류가 발생했습니다.");
        }
    }

    // 환율 데이터 가져오기
    async function fetchExchangeRate() {
        try {
            console.log("[INFO] Fetching exchange rate...");
            const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=krw');
            const data = await response.json();

            console.log("[INFO] Exchange rate data:", data);

            const ethToKrwRate = data.ethereum.krw;
            const totalPrice = parseFloat(document.getElementById('totalPrice').innerText) || 0;
            const ethPrice = totalPrice / ethToKrwRate;

            document.getElementById('ethPrice').innerText = ethPrice.toFixed(6) + ' ETH';
            document.getElementById('ethAmount').value = ethPrice.toFixed(6);

            console.log("[INFO] Calculated ETH price:", ethPrice.toFixed(6));
        } catch (error) {
            console.error("[ERROR] Failed to fetch exchange rate:", error);
        }
    }

    // 결제 제출
    async function submitPayment() {
        try {
            console.log("[INFO] Starting payment process...");
            const cartId = sessionStorage.getItem('cartId');
            const buyerName = document.getElementById('buyerName').value;
            const buyerAddress = document.getElementById('buyerAddress').value;
            const buyerContact = document.getElementById('buyerContact').value;

            if (!cartId || !buyerName || !buyerAddress || !buyerContact) {
                throw new Error("모든 필드를 채워야 합니다.");
            }

            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const buyer = accounts[0];
            console.log("[INFO] Using account:", buyer);

            const transactionHash = "dummy_tx_hash"; // 실제 MetaMask 트랜잭션 발생 시 설정

            const response = await fetch('/api/cart/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cartId,
                    buyerName,
                    buyerAddress,
                    buyerContact,
                    transactionHash,
                }),
            });

            if (!response.ok) throw new Error(await response.text());

            alert("결제가 성공적으로 완료되었습니다!");
            window.location.href = '/home';

        } catch (error) {
            console.error("[ERROR] Payment Error:", error);
            alert("결제 처리 중 오류가 발생했습니다.");
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await fetchCartDetails();
        await fetchExchangeRate();
        document.getElementById('submitPaymentBtn').addEventListener('click', submitPayment);
    });
</script>
</body>
</html>