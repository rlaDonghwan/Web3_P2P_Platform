<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장바구니 결제</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/sendEther.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container mt-5">
    <div th:insert="~{nav.html}" class="fixed-top"></div>
    <div th:insert="~{popup.html}"></div>
    <script th:src="@{/js/login.js}"></script>


    <!-- 판매자별 상품 -->
    <div th:each="entry : ${sellerItemsMap}" class="mb-3 p-3 border rounded">
        <h5 th:text="'판매자: ' + ${entry.key.accountId.substring(0, 10)}">판매자 이름</h5>
        <div th:each="cartItem : ${entry.value}">
            <img th:src="${cartItem.item.images != null && cartItem.item.images.size() > 0 ? cartItem.item.images[0].base64Image : '/images/default.jpg'}"
                 alt="상품 이미지" style="width: 100px; height: 100px; object-fit: cover; margin-right: 10px;">
            <p>상품명: <span th:text="${cartItem.item.itemName}">상품 이름</span></p>
            <p>수량: <span th:text="${cartItem.quantity}">0</span></p>
            <p>가격: <span th:text="'₩' + (${cartItem.price} * ${cartItem.quantity})">₩0</span></p>
        </div>
        <p>판매자 총 금액: <span th:text="'₩' + ${sellerTotals[entry.key]}">₩0</span></p>
    </div>

    <h3>총 금액: <span th:text="'₩' + ${totalPrice}">₩0</span></h3>
    <p>이더리움 금액: <span id="ethPrice">계산 중...</span> ETH</p>

    <!-- 결제 정보 입력 -->
    <h4>결제 정보 입력</h4>
    <form id="paymentForm">
        <div class="form-group">
            <label for="buyerName">이름:</label>
            <input type="text" id="buyerName" name="buyerName" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="buyerAddress">주소:</label>
            <input type="text" id="buyerAddress" name="buyerAddress" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="buyerContact">연락처:</label>
            <input type="text" id="buyerContact" name="buyerContact" class="form-control" required>
        </div>

        <!-- 이더리움 금액을 저장할 숨겨진 필드 -->
        <input type="hidden" id="ethAmount" name="ethAmount">

        <button type="button" onclick="submitPayment()" class="btn btn-primary btn-block">결제하기</button>
    </form>
</div>

<script>
    const totalPrice = [[${totalPrice}]]; // 총 금액
    const apiURL = 'https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=krw';
    let ethToKrwRate = 1406; // 기본 환율: 1406원

    // 환율 조회 함수
    async function fetchExchangeRate() {
        try {
            const response = await fetch(apiURL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.ethereum && data.ethereum.krw) {
                ethToKrwRate = data.ethereum.krw;
                console.log("ETH to KRW rate updated:", ethToKrwRate);
            }
        } catch (error) {
            console.error("환율 조회 중 오류:", error);
        } finally {
            updateEthPrice();
        }
    }

    // 이더리움 금액 업데이트
    function updateEthPrice() {
        const ethPrice = totalPrice / ethToKrwRate;
        document.getElementById('ethPrice').innerText = ethPrice.toFixed(6);
        document.getElementById('ethAmount').value = ethPrice.toFixed(6); // 숨겨진 필드 업데이트
        console.log("Updated ETH Price:", ethPrice.toFixed(6));
    }

    // 결제 정보 제출 함수
    async function submitPayment() {
        const buyerName = document.getElementById('buyerName').value;
        const buyerAddress = document.getElementById('buyerAddress').value;
        const buyerContact = document.getElementById('buyerContact').value;
        const ethAmount = document.getElementById('ethAmount').value;

        // 서버로 결제 데이터 전송
        try {
            const response = await fetch('/payment/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    buyerName,
                    buyerAddress,
                    buyerContact,
                    ethAmount,
                    totalPrice
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`서버 오류: ${errorText}`);
            }

            alert('결제가 성공적으로 완료되었습니다!');
            window.location.href = '/'; // 결제 완료 후 메인 페이지로 이동
        } catch (error) {
            console.error('결제 처리 중 오류:', error);
            alert('결제 처리 중 오류가 발생했습니다. 다시 시도해주세요.');
        }
    }

    // DOMContentLoaded에서 환율 조회 및 자동 갱신 설정
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Fetching ETH to KRW exchange rate...');
        fetchExchangeRate();

        // 5분마다 환율 자동 갱신
        setInterval(fetchExchangeRate, 300000); // 300,000ms = 5분
    });
</script>
</body>
</html>