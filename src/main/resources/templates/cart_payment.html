<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장바구니 결제</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.5.2/dist/web3.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">장바구니 결제</h2>

    <!-- 판매자별 상품 -->
    <div th:each="entry : ${sellerItemsMap}" class="mb-3 p-3 border rounded">
        <h5 th:text="'판매자: ' + ${entry.key.accountId.substring(0, 10)}">판매자 이름</h5>
        <div th:each="cartItem : ${entry.value}">
            <p>상품명: <span th:text="${cartItem.item.itemName}">상품 이름</span></p>
            <p>수량: <span th:text="${cartItem.quantity}">0</span></p>
            <p>가격: <span th:text="'₩' + (${cartItem.price} * ${cartItem.quantity})">₩0</span></p>
        </div>
        <p>판매자 총 금액: <span th:text="'₩' + ${sellerTotals[entry.key]}">₩0</span></p>
    </div>

    <h3>총 금액: <span th:text="'₩' + ${totalPrice}">₩0</span></h3>
    <p>이더리움 금액: <span id="ethPrice">계산 중...</span> ETH</p>

    <!-- 결제 버튼 -->
    <button id="payButton" class="btn btn-primary btn-block mt-3">결제하기</button>
</div>

<script>
    // JavaScript에 Thymeleaf 데이터 전달
    const totalPrice = [[${totalPrice}]]; // 총 금액
    const sellers = [[${sellerItemsJson}]]; // 판매자 정보 JSON
    const sellerAmounts = [[${sellerAmountsJson}]]; // 판매자별 금액 JSON
    const contractAddress = '[[${contractAddress}]]'; // 스마트 컨트랙트 주소
    const infuraApiKey = '[[${infuraApiKey}]]'; // Infura API 키
    const apiURL = 'https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=krw';

    if (!contractAddress || !infuraApiKey) {
        alert("결제를 처리할 수 없습니다. 관리자에게 문의하세요.");
        throw new Error("스마트 컨트랙트 주소 또는 Infura API 키가 누락되었습니다.");
    }

    const web3 = new Web3(`https://sepolia.infura.io/v3/${infuraApiKey}`);
    let ethToKrwRate = 1406; // 기본 환율: 1406원

    // 환율 조회 함수
    async function fetchExchangeRate() {
        try {
            const response = await fetch(apiURL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.ethereum && data.ethereum.krw) {
                ethToKrwRate = data.ethereum.krw;
                console.log("ETH to KRW rate:", ethToKrwRate);
            }
        } catch (error) {
            console.error("환율 조회 중 오류:", error);
            alert("환율 조회 실패: 기본 환율(₩1406)을 사용합니다.");
        } finally {
            updatePrices();
        }
    }



    // 스마트 컨트랙트 초기화 함수
    async function initializeContract() {
        try {
            const response = await fetch('/smartContract/ContractABI.json');
            const abi = await response.json();
            console.log("Smart contract ABI loaded:", abi);

            return new web3.eth.Contract(abi, contractAddress);
        } catch (error) {
            console.error("스마트 컨트랙트 초기화 오류:", error);
            alert("스마트 컨트랙트 초기화 실패");
            return null;
        }
    }

    // 결제 처리 함수
    async function handlePayment(contract) {
        try {
            const accounts = await web3.eth.requestAccounts(); // 사용자 계정 요청
            const buyer = accounts[0]; // 구매자 주소 설정
            console.log("Buyer account:", buyer);

            if (!sellers.length || !sellerAmounts.length) {
                alert("판매자 정보가 없습니다.");
                return;
            }

            console.log("Sellers:", sellers);
            console.log("Seller Amounts:", sellerAmounts);

            // 판매자 주소와 금액을 설정
            const sellerAddresses = sellers.map(seller => seller.accountId);
            const sellerAmountsInWei = sellerAmounts.map(amount =>
                web3.utils.toWei((amount / ethToKrwRate).toFixed(6), 'ether') // 이더리움으로 변환
            );

            console.log("Seller Addresses:", sellerAddresses);
            console.log("Seller Amounts in Wei:", sellerAmountsInWei);

            // 주문 생성
            const orderId = await contract.methods
                .createOrder(sellerAddresses, sellerAmountsInWei)
                .send({ from: buyer });

            console.log("Order ID:", orderId);

            const totalAmountInWei = web3.utils.toWei(
                (totalPrice / ethToKrwRate).toFixed(6),
                'ether'
            );

            console.log("Total Amount in Wei:", totalAmountInWei);

            // 주문 결제
            await contract.methods
                .payOrder(orderId)
                .send({ from: buyer, value: totalAmountInWei });

            console.log("Payment successful");

            // 자금 분배
            await contract.methods.distributeFunds(orderId).send({ from: buyer });
            console.log("Funds distributed successfully");

            alert("결제가 성공적으로 완료되었습니다!");
            window.location.href = '/'; // 결제 완료 후 리다이렉트
        } catch (error) {
            console.error("결제 처리 중 오류:", error);
            alert("결제 처리 실패: " + error.message);
        }
    }

    // DOMContentLoaded에서 초기화 및 결제 버튼 이벤트 설정
    document.addEventListener("DOMContentLoaded", async () => {
        console.log("Page loaded. Setting up payment functionality...");
        await fetchExchangeRate();

        const contract = await initializeContract();
        if (contract) {
            document.getElementById("payButton").addEventListener("click", async () => {
                console.log("Payment button clicked.");
                try {
                    if (!window.ethereum) {
                        alert("MetaMask가 설치되지 않았습니다. 설치 후 다시 시도해주세요.");
                        return;
                    }

                    const accounts = await web3.eth.requestAccounts();
                    if (!accounts || accounts.length === 0) {
                        alert("MetaMask 계정 연결이 필요합니다.");
                        return;
                    }

                    console.log("Buyer account:", accounts[0]);
                    await handlePayment(contract);
                } catch (error) {
                    console.error("Error during payment process:", error);
                    alert("결제 중 오류가 발생했습니다: " + error.message);
                }
            });
        } else {
            console.error("Contract initialization failed.");
        }
    });
</script>
</body>
</html>