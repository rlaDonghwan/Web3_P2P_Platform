<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>결제 페이지</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.5.2/dist/web3.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/sendEther.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div th:insert="~{nav.html}" class="fixed-top"></div>
<div class="d-flex justify-content-center align-items-center vh-100" style="padding-top: 80px;">
    <div id="etherForm">
        <button type="button" id="connectButton" onclick="connectMetaMask()" class="btn btn-primary mb-3">메타마스크 연결</button>
        <label for="fromAddress">보내는 사람:</label>
        <input type="text" id="fromAddress" name="fromAddress" readonly>
        <label for="toAddress">받는 사람:</label>
        <input type="text" id="toAddress" name="toAddress" required>
        <label for="amount">수량(이더리움):</label>
        <input type="text" id="amount" name="amount" required>
        <button type="button" onclick="sendEther()" class="btn btn-primary mt-3">송금</button>
        <p id="status"></p>
    </div>
</div>

<script>
    // URL에서 쿼리 파라미터 가져오기 함수
    function getQueryParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // 수량 확인 및 예약 요청 함수
    async function checkAndReserveQuantity() {
        const itemId = getQueryParameter('itemId');
        const quantity = document.getElementById("amount").value;

        const response = await fetch(`/checkQuantity`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ itemId, quantity })
        });

        const result = await response.text();

        if (result === "Insufficient quantity") {
            alert("죄송합니다, 주문 수량이 부족합니다.");
            return false;
        }
        return true; // 수량이 충분하면 송금 진행
    }

    async function connectMetaMask() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                document.getElementById('fromAddress').value = accounts[0];
                document.getElementById('status').innerHTML = "MetaMask connected!";
            } catch (error) {
                document.getElementById('status').innerHTML = `Error: ${error.message}`;
                document.getElementById('status').classList.add('error');
            }
        } else {
            alert("MetaMask not installed");
        }
    }

    // 트랜잭션 상태를 확인하는 함수
    async function checkTransactionStatus(txHash) {
        const web3 = new Web3(window.ethereum);
        while (true) {
            const receipt = await web3.eth.getTransactionReceipt(txHash);
            if (receipt) {
                return receipt; // 트랜잭션 상태 반환
            }
            await new Promise(resolve => setTimeout(resolve, 1000)); // 1초 대기 후 재확인
        }
    }

    // MetaMask와의 송금 트랜잭션 진행 함수
    async function sendEther() {
        const canProceed = await checkAndReserveQuantity();
        if (!canProceed) return;

        const fromAddress = document.getElementById("fromAddress").value;
        const toAddress = document.getElementById("toAddress").value;
        const amount = document.getElementById("amount").value;

        if (!fromAddress || !toAddress || !amount) {
            document.getElementById("status").innerHTML = "모든 필드를 채워 주세요";
            document.getElementById('status').classList.add('error');
            return;
        }

        if (typeof window.ethereum !== 'undefined') {
            try {
                const web3 = new Web3(window.ethereum);
                const transactionParameters = {
                    to: toAddress,
                    from: fromAddress,
                    value: web3.utils.toHex(web3.utils.toWei(amount, 'ether'))
                };

                ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParameters],
                })
                    .then(async (txHash) => {
                        document.getElementById("status").innerHTML = `Transaction Hash: ${txHash}`;
                        const transactionReceipt = await checkTransactionStatus(txHash);

                        if (transactionReceipt && transactionReceipt.status) {
                            alert("송금이 완료되었습니다!");
                            await saveOrder(); // 결제 내역 저장
                        } else {
                            alert("트랜잭션이 실패했습니다.");
                        }
                    })
                    .catch((error) => {
                        console.log(error);
                        document.getElementById("status").innerHTML = `Error: ${error.message}`;
                        document.getElementById('status').classList.add('error');
                    });
            } catch (error) {
                console.log(error);
                document.getElementById("status").innerHTML = `Error: ${error.message}`;
                document.getElementById('status').classList.add('error');
            }
        } else {
            document.getElementById("status").innerHTML = "MetaMask가 설치되어 있지 않습니다.";
            document.getElementById('status').classList.add('error');
        }
    }

    // 결제 내역을 서버에 저장하는 함수
    async function saveOrder() {
        const userId = getUserId(); // 현재 사용자의 ID를 가져오는 함수
        const itemId = getQueryParameter('itemId'); // URL에서 아이템 ID 가져오기
        const quantity = document.getElementById("amount").value; // 주문 수량

        // 주문자 정보 가져오기
        const buyerName = document.getElementById("buyerName") ? document.getElementById("buyerName").value : '';
        const buyerAddress = document.getElementById("buyerAddress") ? document.getElementById("buyerAddress").value : '';
        const buyerContact = document.getElementById("buyerContact") ? document.getElementById("buyerContact").value : '';

        // 서버에 주문 저장 요청
        const response = await fetch(`/process`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, itemId, quantity, buyerName, buyerAddress, buyerContact })
        });

        const result = await response.text();
        if (result === "Order saved successfully") {
            alert("주문이 성공적으로 저장되었습니다.");
        } else {
            alert("주문 저장에 실패했습니다.");
        }
    }

    // 예시 사용자 ID 가져오기 (실제로는 서버에서 받아오는 로직으로 대체)
    function getUserId() {
        return "exampleUserId";
    }
</script>
</body>
</html>